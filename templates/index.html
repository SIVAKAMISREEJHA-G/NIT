<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Analysis Options</title>
    <link rel="stylesheet" href="/static/css/home.css">
</head>
<body>
    <!-- Dashboard Button -->
    <div class="top-right">
        <a href="/dashboard" class="dashboard-button">Dashboard</a>
    </div>

    <div class="container">
        <div class="weather-box">
            <h2>Weather Details</h2>
            <p><strong>Location:</strong> {{ location }}</p>
            <p><strong>Temperature:</strong> {{ weather['current']['temperature_2m'] }}Â°C</p>
            <p><strong>Humidity:</strong> {{ weather['current']['relative_humidity_2m'] }}%</p>
            <p><strong>Wind Speed:</strong> {{ weather['current']['wind_speed_10m'] }} km/h</p>
        </div>
        <div class="recommendations">
            <h2>Recommendations(from weather)</h2>
            {% for rec in recommendations %}
                <p>{{ rec }}</p>
            {% endfor %}
        </div>
    </div>

    <div class="container">
        <h1>Welcome to the Analysis Tool</h1>
        <p>Select an option below to start your analysis:</p>
        <div class="options">
            <a href="/upload" class="button">Start Analysis</a>
            <a href="/yield_prediction" class="button">Yield Prediction</a>
        </div>
    </div>

<!-- Chatbot UI -->
<div id="chatbot-container">
    <div id="chat-header">Agri Chatbot</div>
    <div id="chat-messages"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ask about agriculture..." />
        <button id="send-btn">Send</button>
    </div>
</div>

<style>
    #chatbot-container {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 300px;
        background: white;
        border: 2px solid #4CAF50;
        border-radius: 10px;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        z-index: 1000;
    }
    #chat-header {
        background: #4CAF50;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
    }
    #chat-messages {
        height: 200px;
        overflow-y: auto;
        padding: 10px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    #chat-input-area {
        display: flex;
        border-top: 1px solid #e0e0e0;
        padding: 8px;
    }
    #chat-input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px 0 0 4px;
        outline: none;
    }
    #send-btn {
        padding: 8px 15px;
        border: none;
        background: #4CAF50;
        color: rgb(255, 253, 253);
        border-radius: 0 4px 4px 0;
        cursor: pointer;
    }
    .user-message {
        background-color: #5aaa32;
        padding: 8px 12px;
        border-radius: 8px 8px 0 8px;
        align-self: flex-end;
        max-width: 80%;
        margin-top: 4px;
    }
    .bot-message {
        background-color: #5aaa32;
        padding: 8px 12px;
        border-radius: 8px 8px 8px 0;
        align-self: flex-start;
        max-width: 80%;
        margin-top: 4px;
    }
    .thinking {
        color: #ddc9c9;
        font-style: italic;
    }
</style>

<script>
    document.getElementById("send-btn").addEventListener("click", sendMessage);
    document.getElementById("chat-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") sendMessage();
    });

    // Add a welcome message when the page loads
    window.addEventListener('DOMContentLoaded', (event) => {
        const chatMessages = document.getElementById("chat-messages");
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'bot-message';
        welcomeDiv.textContent = "Hello! I'm your agricultural assistant. How can I help you today?";
        chatMessages.appendChild(welcomeDiv);
    });

    function sendMessage() {
        const userMessage = document.getElementById("chat-input").value.trim();
        if (!userMessage) return;

        const chatMessages = document.getElementById("chat-messages");

        // Create and append user message element
        const userDiv = document.createElement('div');
        userDiv.className = 'user-message';
        userDiv.textContent = userMessage;
        chatMessages.appendChild(userDiv);
        
        // Auto-scroll to the latest message
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Clear input field
        document.getElementById("chat-input").value = "";

        // Create and append thinking message element
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'bot-message thinking';
        thinkingDiv.id = 'thinking-indicator';
        thinkingDiv.textContent = "Thinking...";
        chatMessages.appendChild(thinkingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Send request to the chatbot API
        fetch("/chatbot", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userMessage })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Remove thinking indicator
            const thinkingIndicator = document.getElementById('thinking-indicator');
            if (thinkingIndicator) {
                thinkingIndicator.remove();
            }
            
            // Create and append bot response element
            const botDiv = document.createElement('div');
            botDiv.className = 'bot-message';
            
            // Check if response exists and use it
            if (data && data.response) {
                botDiv.textContent = data.response;
            } else {
                botDiv.textContent = "Sorry, I couldn't generate a response.";
                console.error("Invalid response format:", data);
            }
            
            chatMessages.appendChild(botDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(error => {
            // Remove thinking indicator
            const thinkingIndicator = document.getElementById('thinking-indicator');
            if (thinkingIndicator) {
                thinkingIndicator.remove();
            }
            
            // Create and append error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bot-message';
            errorDiv.textContent = "Sorry, I couldn't connect to my knowledge base. Please try again.";
            chatMessages.appendChild(errorDiv);
            
            console.error("Error in chatbot communication:", error);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }
</script>
</body>
</html>
